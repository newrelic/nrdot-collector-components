# Adaptive Telemetry Processor

A barebones OpenTelemetry Collector processor component with all the plumbing in place, ready for implementation.

## Status

**Development** - This is a skeleton implementation with infrastructure set up but core functionality not yet implemented.

## What's Included

This processor has been set up with:

✅ **Full integration with the nrdot-collector-components repository**
- Registered in `versions.yaml`
- Included in both `nrdotcol` and `oteltestbedcol` binary configurations
- Proper module structure with `go.mod`
- Code generation via `mdatagen` (metadata.yaml + doc.go)

✅ **Minimal working implementation**
- `config.go` - Configuration structure (ready to add fields)
- `processor.go` - Main processor logic (currently pass-through)
- `factory.go` - Factory for creating processor instances
- Basic test files for all components

✅ **Quality checks passing**
- `make checkapi` ✓
- `make multimod-verify` ✓
- `make checkdoc` ✓
- `make checkmetadata` ✓
- All unit tests passing ✓

## Project Structure

```
processor/adaptivetelemetryprocessor/
├── README.md                      # This file
├── metadata.yaml                  # Component metadata for code generation
├── doc.go                         # Package documentation with generate pragma
├── go.mod                         # Go module definition
├── Makefile                       # Build targets
│
├── config.go                      # Configuration structure
├── config_test.go                 # Configuration tests
├── processor.go                   # Main processor implementation
├── processor_test.go              # Processor tests
├── factory.go                     # Factory for creating processor instances
├── factory_test.go                # Factory tests
│
├── generated_*.go                 # Auto-generated by mdatagen (don't edit)
└── internal/metadata/             # Auto-generated metadata code
```

## Getting Started

### Building

From the repository root:
```bash
make generate                  # Regenerate code from metadata.yaml
make gennrdotcol              # Rebuild nrdotcol with the processor
make genoteltestbedcol        # Rebuild testbed binary with the processor
```

From the processor directory:
```bash
go build .                    # Build the processor module
go test ./...                 # Run all tests
```

### Running Tests

```bash
# Run tests for this processor
cd processor/adaptivetelemetryprocessor
go test -v ./...

# Run tests for entire repository
cd ../..
make gotest
```

### Development Workflow

1. **Add configuration fields** in `config.go`:
   ```go
   type Config struct {
       // Add your configuration fields here
       MetricThresholds map[string]float64 `mapstructure:"metric_thresholds"`
   }
   ```

2. **Update processor state** in `processor.go`:
   ```go
   type adaptiveProcessor struct {
       logger       *zap.Logger
       config       *Config
       nextConsumer consumer.Metrics
       // Add your internal state here
   }
   ```

3. **Implement processing logic** in the `ConsumeMetrics` method:
   ```go
   func (p *adaptiveProcessor) ConsumeMetrics(ctx context.Context, md pmetric.Metrics) error {
       // Your implementation here
       return p.nextConsumer.ConsumeMetrics(ctx, md)
   }
   ```

4. **Add tests** as you implement features

5. **Run quality checks** before committing:
   ```bash
   make generate              # Regenerate code if metadata changed
   make checkapi             # Verify API compatibility
   make gotest               # Run tests
   make golint               # Run linters
   ```

## Implementation Notes

### Current Behavior

The processor currently:
- Accepts metrics pipeline configuration
- Passes all metrics through unchanged (no filtering/modification)
- Logs startup and shutdown events
- Reports `MutatesData: false` in capabilities

### TODO: Implementation Tasks

The following areas need implementation:

1. **Configuration**
   - Define configuration fields in `config.go`
   - Add validation logic in `Validate()`
   - Add default values in `factory.go`'s `createDefaultConfig()`

2. **Processing Logic**
   - Implement metric filtering/transformation in `ConsumeMetrics()`
   - Add any necessary internal state to the `adaptiveProcessor` struct
   - Initialize state in `newProcessor()`

3. **Lifecycle Management**
   - Add initialization logic in `Start()` if needed
   - Add cleanup logic in `Shutdown()` if needed

4. **Testing**
   - Add test cases for your configuration validation
   - Add test cases for your processing logic
   - Consider integration tests if needed

## Example Configuration

Once implemented, the processor could be configured like:

```yaml
processors:
  adaptivetelemetry:
    # Your configuration options here
    # Example (not yet implemented):
    # metric_thresholds:
    #   process.cpu.utilization: 5.0
```

## Resources

- [OpenTelemetry Collector Processor Documentation](https://opentelemetry.io/docs/collector/building/processor/)
- [OpenTelemetry Collector Builder Documentation](https://github.com/open-telemetry/opentelemetry-collector/tree/main/cmd/builder)
- [Repository ADDING_COMPONENTS.md](../../docs/ADDING_COMPONENTS.md)
- [pdata API Reference](https://pkg.go.dev/go.opentelemetry.io/collector/pdata)

## Support

For questions or issues, please refer to the team's communication channels.
